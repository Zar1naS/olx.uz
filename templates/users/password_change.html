{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Parolni o'zgartirish" %} | OLX{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'core:home' %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-house-door me-1"></i>{% trans "Bosh sahifa" %}
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'users:profile' user.username %}" class="text-decoration-none">
                            {% trans "Profil" %}
                        </a>
                    </li>
                    <li class="breadcrumb-item active">
                        {% trans "Parolni o'zgartirish" %}
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-key me-2"></i>{% trans "Parolni o'zgartirish" %}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Current Password -->
                        <div class="mb-3">
                            <label for="{{ form.old_password.id_for_label }}" class="form-label">
                                <i class="bi bi-lock me-1"></i>{{ form.old_password.label }}
                            </label>
                            {{ form.old_password }}
                            {% if form.old_password.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.old_password.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                {% trans "Joriy parolingizni kiriting" %}
                            </div>
                        </div>

                        <!-- New Password -->
                        <div class="mb-3">
                            <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                                <i class="bi bi-key me-1"></i>{{ form.new_password1.label }}
                            </label>
                            {{ form.new_password1 }}
                            {% if form.new_password1.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.new_password1.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                <small>
                                    {% trans "Parolingiz quyidagi talablarga javob berishi kerak:" %}
                                    <ul class="mt-1 mb-0">
                                        <li>{% trans "Kamida 8 ta belgi" %}</li>
                                        <li>{% trans "Faqat raqamlardan iborat bo'lmasligi kerak" %}</li>
                                        <li>{% trans "Juda oddiy bo'lmasligi kerak" %}</li>
                                    </ul>
                                </small>
                            </div>
                        </div>

                        <!-- Confirm New Password -->
                        <div class="mb-4">
                            <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                                <i class="bi bi-check-circle me-1"></i>{{ form.new_password2.label }}
                            </label>
                            {{ form.new_password2 }}
                            {% if form.new_password2.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.new_password2.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                {% trans "Yangi parolni takrorlang" %}
                            </div>
                        </div>

                        <!-- Security Warning -->
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>{% trans "Muhim!" %}</strong>
                            {% trans "Parol o'zgartirilgandan so'ng barcha qurilmalarda qayta tizimga kirishingiz kerak bo'ladi." %}
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check2 me-2"></i>{% trans "Parolni o'zgartirish" %}
                            </button>
                            <a href="{% url 'users:profile_edit' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>{% trans "Bekor qilish" %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Tips Card -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-shield-check me-2 text-success"></i>{% trans "Xavfsizlik maslahatlari" %}
                    </h6>
                    <ul class="list-unstyled mb-0 small">
                        <li class="mb-2">
                            <i class="bi bi-check text-success me-2"></i>
                            {% trans "Kuchli parol tanlan: harflar, raqamlar va belgilar kombinatsiyasi" %}
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check text-success me-2"></i>
                            {% trans "Parolni boshqalar bilan baham ko'rmang" %}
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check text-success me-2"></i>
                            {% trans "Turli saytlarda har xil parollar ishlating" %}
                        </li>
                        <li class="mb-0">
                            <i class="bi bi-check text-success me-2"></i>
                            {% trans "Parolni muntazam ravishda yangilang" %}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPassword1 = document.querySelector('input[name="new_password1"]');
    const newPassword2 = document.querySelector('input[name="new_password2"]');
    
    // Password strength indicator
    if (newPassword1) {
        newPassword1.addEventListener('input', function() {
            const password = this.value;
            const strength = checkPasswordStrength(password);
            showPasswordStrength(this, strength);
        });
    }
    
    // Password match indicator
    if (newPassword2) {
        newPassword2.addEventListener('input', function() {
            const password1 = newPassword1.value;
            const password2 = this.value;
            showPasswordMatch(this, password1 === password2 && password2.length > 0);
        });
    }
});

function checkPasswordStrength(password) {
    let strength = 0;
    
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    return strength;
}

function showPasswordStrength(input, strength) {
    // Remove existing feedback
    const existingFeedback = input.parentNode.querySelector('.password-strength');
    if (existingFeedback) {
        existingFeedback.remove();
    }
    
    if (input.value.length === 0) return;
    
    const strengthDiv = document.createElement('div');
    strengthDiv.className = 'password-strength mt-1 small';
    
    let strengthText, strengthClass;
    switch (strength) {
        case 0:
        case 1:
            strengthText = '{% trans "Zaif" %}';
            strengthClass = 'text-danger';
            break;
        case 2:
        case 3:
            strengthText = '{% trans "O\'rtacha" %}';
            strengthClass = 'text-warning';
            break;
        case 4:
        case 5:
            strengthText = '{% trans "Kuchli" %}';
            strengthClass = 'text-success';
            break;
    }
    
    strengthDiv.innerHTML = `<i class="bi bi-shield-check me-1"></i>{% trans "Parol kuchi:" %} <span class="${strengthClass}">${strengthText}</span>`;
    input.parentNode.appendChild(strengthDiv);
}

function showPasswordMatch(input, isMatch) {
    // Remove existing feedback
    const existingFeedback = input.parentNode.querySelector('.password-match');
    if (existingFeedback) {
        existingFeedback.remove();
    }
    
    if (input.value.length === 0) return;
    
    const matchDiv = document.createElement('div');
    matchDiv.className = 'password-match mt-1 small';
    
    if (isMatch) {
        matchDiv.innerHTML = '<i class="bi bi-check-circle text-success me-1"></i><span class="text-success">{% trans "Parollar mos keldi" %}</span>';
    } else {
        matchDiv.innerHTML = '<i class="bi bi-x-circle text-danger me-1"></i><span class="text-danger">{% trans "Parollar mos kelmadi" %}</span>';
    }
    
    input.parentNode.appendChild(matchDiv);
}
</script>
{% endblock %}
